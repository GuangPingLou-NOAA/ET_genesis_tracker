#!/bin/sh

# USE_OPER_VITALS=NO
export USE_OPER_VITALS=YES
# USE_OPER_VITALS=INIT_ONLY

#export PS4=' + genesis_tracker_poe.sh line $LINENO: '
export PS4='$SECONDS + genesis_tracker_poe.sh line $LINENO: '

set +x
##############################################################################
echo " "
echo "------------------------------------------------"
echo "xxxx - Track vortices in model GRIB output"
echo "------------------------------------------------"
echo "History: Mar 1998 - Marchok - First implementation of this new script."
echo "         Apr 1999 - Marchok - Modified to allow radii output file and"
echo "                              to allow reading of 4-digit years from"
echo "                              TC vitals file."
echo "         Oct 2000 - Marchok - Fixed bugs: (1) copygb target grid scanning"
echo "                              mode flag had an incorrect value of 64"
echo "                              (this prevented Eta, NGM and ECMWF from"
echo "                              being processed correctly);" 
echo "                              Set it to 0."
echo "                              (2) ECMWF option was using the incorrect"
echo "                              input date (today's date instead of "
echo "                              yesterday's)."
echo "         Jan 2001 - Marchok - Hours now listed in script for each model"
echo "                              and passed into program.  Script included"
echo "                              to process GFDL & Ensemble data.  Call to"
echo "                              DBN included to pass data to OSO and the"
echo "                              Navy.  Forecast length extended to 180"
echo "                              hours for GFS."
echo "         Nov 2004 - Burroughs - Modified scripts to make extratropical"
echo "                              storm tracker operational.  Added hooks in"
echo "                              post processing jobs for various models."
echo "         May 2006 - Burroughs - Modified scripts to accommodate the new"
echo "                              gefs file structure.  Cut the number of"
echo "                              files used by going from 6-h frequency to"
echo "                              12-h frequency from 120 - 180-h."
echo "       May 2007 - Guang P Lou - Expanded scripts to include the following"
echo "                    changes: "
echo "                  1. Short range ensembles(sref) expanded to 21 from 14;  "
echo "                     model forecast length increased from 63hrs to 87hrs      "
echo "                  2. Canadian model is added                                 "
echo "                  3. Canadian ensemble with 17 perturbation runs are initiated  "
echo "                  4. ECMWF model frequency increased from 1 (00z) to 2 (00z,12z); "
echo "                     model length extended from 180hrs to 240hrs    "
echo "                  5. ECMWF ensemble runs with 50 components are added; "
echo "                     ECMWF ensemble runs once a day only at 12z to 240hrs "
echo "                  6. Region domain boundaries have changed for ecml and wpcg"
echo "                     and domain cptg has been removed                         "
echo "                  7. Tracks are sorted to order and to files according "
echo "                     to region and model and saved for future usage "
echo "                  8. All cyclones lived shorter than 24hrs are removed "
echo "                  9. Tracks are also grouped for graphics in post processing "
echo "                 10. The cyclone center pressure gradient is relaxed to 1hPa from 2hPa  "
echo "  "
echo "       Sept. 2008 - Guang Ping Lou - Expanded scripts to include the following changes: "
echo "                  1. It uses Poe scheme to increase nodes and tasks so that "
echo "                     ensemble runs are assigned as many tasks(CPU) as ensemble members "
echo "                     It reduces wall clock requirements greatly. "
echo "                     The real wall clock should be within 30 minutes for any ensemble. "
echo "                  2. A global version replaces the previous regional tracker. "
echo "                     Now the tracker search domain includes -90~90, 0~360. "
echo "                  3. The atcf text output files include (glbl) in place of "
echo "                     regional ecml, altg, eptg, wptg  "
echo "                  4. The data is output with names (storms.$model.atcfunix.glbl.$yyyy) "
echo "                  5. A new file is created with name (trak.$model.atcf_gen.glbl.$yyyy) " 
echo "                     which has a new Storm ID to include initial date, lead-time in forecast and "
echo "                     lat/lon position where storm was first identified. "
echo "                  6. New text output format includes: "
echo "                     Positions for the 3 diagnostics from Bob Hart's cyclone phase space "
echo "                     (the CPS values are only calculated for lead times > hour 0 or > the "
echo "                     first hour at which the storm was found, since it's critical to have a "
echo "                     good fix on the direction of storm motion). "
echo "                     Mean & max values of relative vorticity near the storm at 850 & 700 "
echo "                     Direction of model storm motion, Translation speed of model storm, "
echo "                     The pressure of the last closed isobar and the radius "
echo "                     of that closed isobar, but found the algorithm to be too unreliable. "
echo "                     Nonetheless, the values are output   "
echo "                  7. A CXML script is added to generate a cyclone output format "
echo "                     that confines with the international format "
echo " "
echo "                    In the event of a crash, you can contact Guang Ping Lou "
echo "                    at NCEP/EMC at (301) 763-8000x7252 or "
echo "                    guang.ping.lou@noaa.gov or Tim Marchok at "
echo "                    tpm@gfdl.gov"
echo "                    8/20/13 - Magee - change ngps to nvgm."
echo " "
echo "Current time is: `date`"
echo " "
##############################################################################
set -x

##############################################################################
#
#    FLOW OF CONTROL
#
# 1. Define data directories and file names for the input model 
# 3. Define extratropical and tropical regions
# 3. Process input starting date/cycle information
# 4. Update TC Vitals file and select storms to be processed
# 5. Cut apart input GRIB files to select only the needed parms and hours
# 6. Execute the tracker
# 7. Copy the output track files to various locations
#
##############################################################################

########################################
msg="has begun for ${cmodel} at ${cyc}z"
postmsg "$jlogfile" "$msg"
########################################

# This script runs the hurricane tracker using operational GRIB model output.  
# This script makes sure that the data files exist, it then pulls all of the 
# needed data records out of the various GRIB forecast files and puts them 
# into one, consolidated GRIB file, and then runs a program that reads the TC 
# Vitals records for the input day and updates the TC Vitals (if necessary).
# It then runs genesis_gettrk, which actually does the tracking.
# 
# Environmental variable inputs needed for this script:
#  PDY      -- The date for data being processed, in YYYYMMDD format
#  CYL      -- The numbers for the cycle for data being processed (00, 06, 09, 
#              12, 18, 21)
#  cmodel   -- Model being processed (gfs, ukmet, ecmwf, nam, nvgm, gdas, gfdl, 
#              gefs (ncep GFS ensemble), sref (nam ensemble), cens (canadian 
#              ensemble; to be added), north american ensemble - to be added)
#  envir    -- 'prod', 'para', or 'test'
#  SENDCOM  -- 'YES' or 'NO'
#  stormenv -- This is only needed by the tracker run for the GFDL model.
#              'stormenv' contains the name/id that is used in the input
#              grib file names.
#  pert     -- This is only needed by the tracker run for the NCEP ensembles.
#              'pert' contains the ensemble member id (e.g., n2, p4, etc.)
#              which is used as part of the grib file names.
#  loopnum  -- This is used to determine which region is used by the program;
#              region types (regtype) include:
#                 ecml = Extratropical cyclogenesis, mid-latitude Atlantic and
#                        Pacific; loopnum = 1
#                 altg = Atlantic Basin, tropical cyclogenesis; loopnum = 2
#                 eptg = Eastern Pacific Basin, tropical cyclogenesis;
#                        loopnum = 3
#                 wptg = Western Pacific Basin, tropical cyclogenesis; 
#                        loopnum = 4
#
# For testing script interactively in non-production set following vars:
#     gfsvitdir  - Directory for GFS Error Checked Vitals
#     namvitdir  - Directory for Eta Error Checked Vitals
#     gltrkdir   - Directory for output tracks
#     homesyndir - Directory with syndir scripts/exec/fix 
#     archsyndir - Directory with syndir scripts/exec/fix 
#
#-----------------------------------------------------------------------------
# This job runs the tracker for an input cmodel, loopnum, PDY, and CYL
#-----------------------------------------------------------------------------

set +x
echo " "
echo "Time at beginning of `basename $0` is `date`"
set -x

qid=$$

#--------------------------------------------------
#   Get input information
#--------------------------------------------------

export PDY=${PDY:-$1}
export CYL=${CYL:-$2}
export CYCLE=t${CYL}z
export cmodel=${cmodel:-$3}
export loopnum=${reg:-$4}
export init_flag=$5
export jobid=${jobid:-testjob}
##export jobid=${jobid:-prodjob}
export envir=${envir:-prod}
export COMIN=${COMIN:-$cmodel}
export COMOUT=${COMOUT:-${COMIN}/track}
export SENDCOM=${SENDCOM:-YES}
#SH export PARAFLAG=${PARAFLAG:-YES}
export PARAFLAG=${PARAFLAG:-NO}
export PHASEFLAG=y
export PHASE_SCHEME=cps

export scc=`echo ${PDY} | cut -c1-2`
export syy=`echo ${PDY} | cut -c3-4`
export smm=`echo ${PDY} | cut -c5-6`
export sdd=`echo ${PDY} | cut -c7-8`
export shh=${CYL}
export symd=`echo ${PDY} | cut -c3-8`
export syyyy=`echo ${PDY} | cut -c1-4`
export CENT=${scc}

export DATA=${DATA:-/ptmpp2/Guang.Ping.Lou/tmptrk}

if [ ! -d ${DATA} ];   then mkdir -p ${DATA}; fi

echo "shell is  " $shell

cd $DATA
export COMGLTRK=${COMGLTRK:-${COMROOT}/gentracks/prod/gentracks}
        export savedir=${savedir:-$COMGLTRK/${syyyy}}
if [ ! -d ${savedir} ];   then mkdir -p ${savedir}; fi

#/nwprod/util/ush/setup.sh
. prep_step

if [ ${#PDY} -eq 0 -o ${#CYL} -eq 0 -o ${#cmodel} -eq 0 ]
then
   set +x
   echo " "
   echo "Something wrong with input data.  One or more input variables has "
   echo "length 0. PDY = ${PDY}; CYL = ${CYL}; cmodel = ${cmodel};"
   echo "EXITING.........."
   set -x
   err_exit " FAILED ${jobid} -- BAD INPUTS AT LINE $LINENO IN TRACKER SCRIPT - ABNORMAL EXIT"
else
  set +x
  echo " "
  echo " #-----------------------------------------------------------------#"
  echo " At beginning of tracker script, the following imported variables "
  echo " are defined: "
  echo "   PDY ................................... $PDY"
  echo "   CYL ................................... $CYL"
  echo "   CYCLE ................................. $CYCLE"
  echo "   cmodel ................................ $cmodel"
  echo "   loopnum................................ $loopnum"
  echo "   jobid ................................. $jobid"
  echo "   envir ................................. $envir"
  echo "   SENDCOM ............................... $SENDCOM"
  echo " "
  set -x
fi

export gribver=${gribver:-2}
  if [ ${cmodel} = 'eens' -o ${cmodel} = 'ecmwf' -o ${cmodel} = 'ukmet' ]; then
   export gribver=1
  fi
if [ ${cmodel} = 'gefs' ]; then
# Global ensemble
##  pertstring=' p01 p02 '
  pertstring=' p01 p02 p03 p04 p05 p06 p07 p08 p09 p10 p11 p12 p13 p14 p15 p16 p17 p18 p19 p20 c00'
elif [ ${cmodel} = 'sref' ]; then
# Short range ensemble
#  pertstring=' sac1 san1 sap1 sec1 sec2 sen1 sen2 sen3 sen4 sep1 sep2 sep3 sep4 snc1 snn1 snp1 src1 srn1 srp1 srn2 srp2'
#  pertstring=' sac1 san1 sap1 san2 sap2 sec1 sec2 sen1 sen2 sep1 sep2 snc1 snn1 snp1 snn2 snp2 src1 srn1 srp1 srn2 srp2'
# new members replace old above:
   if [ ${gribver} = 1 ]; then
     pertstring=' sac1 san1 sap1 san2 sap2 san3 sap3 snc1 snn1 snp1 snn2 snp2 snn3 snp3 sbc1 sbn1 sbp1 sbn2 sbp2 sbn3 sbp3'
# new members replace old above Jan 2015:
   else
     pertstring=' sac1 san1 san2 san3 san4 san5 san6 sap1 sap2 sap3 sap4 sap5 sap6 sbc1 sbn1 sbn2 sbn3 sbn4 sbn5 sbn6 sbp1 sbp2 sbp3 sbp4 sbp5 sbp6'
   fi
elif [ ${cmodel} = 'eens' ]; then
# ECMWF ensemble
  pertstring=' p01 p02 p03 p04 p05 p06 p07 p08 p09 p10 p11 p12 p13 p14 p15 p16 p17 p18 p19 p20 p21 p22 p23 p24 p25 n01 n02 n03 n04 n05 n06 n07 n08 n09 n10 n11 n12 n13 n14 n15 n16 n17 n18 n19 n20 n21 n22 n23 n24 n25'
elif [ ${cmodel} = 'cens' ]; then
# Canadian ensemble
  pertstring=' c00 p01 p02 p03 p04 p05 p06 p07 p08 p09 p10 p11 p12 p13 p14 p15 p16 p17 p18 p19 p20'
elif [ ${cmodel} = 'fens' ]; then
  pertstring=' p00 p01 p02 p03 p04 p05 p06 p07 p08 p09 p10 p11 p12 p13 p14 p15 p16 p17 p18 p19 p20'
else 
  pertstring=' xxxx'
fi

set +x
echo " "
echo " "
echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++"
echo " PROCESSING LOOP NUMBER $loopnum IN tracker.sh"
echo "+++++++++++++++++++++++++++++++++++++++++++++++++++++++"
## since the new version covers half hemisphere, loopnum is no longer needed.
echo " "
echo " "
set -x

if [ ${loopnum} -eq 1 ]; then
# glbl: Global tropical cyclogenesis
   export trkrtype=tcgen
   export regtype=tggb
else
# glbl: Global cyclogenesis
   export trkrtype=midlat
   export regtype=glbl
fi
export trkrebd=360.0
export trkrwbd=0.0
export trkrnbd=89.0
export trkrsbd=-89.0

if [ $cmodel = 'gfs' ]; then
   bmodel=gfso
elif [ $cmodel = 'ukmet' ]; then
   bmodel=ukx
elif [ $cmodel = 'ecmwf' ]; then
   bmodel=emx
elif [ $cmodel = 'nvgm' ]; then
   bmodel=ngx
else
   bmodel=$cmodel
fi

export TRKDATA=${DATA}/${bmodel}
if [ ! -d ${TRKDATA} ]; then mkdir -p ${TRKDATA}; fi

rm -rf poe_ens

for pert in ${pertstring}
do

   # Create the poe script for each member
echo "sh $USHtrkr/genesis_gettrk_poe.test.sh $pert" >>poe_ens
done

mv poe_ens cmdfile

chmod +x cmdfile
      export MP_CMDFILE=cmdfile
      export MP_EUIDEVICE=sn_all
      export MP_EUILIB=us
      export MP_PGMMODEL=mpmd
      export MP_TASK_AFFINITY=cpu

#SH ##### Testing with more MP setting for debugging purpose #####
#  export MP_LABELIO=YES
#  export MP_INFOLEVEL=3
##SH ##############################################################

# Execute the poe
mpirun.lsf

#export err=$?; err_chk

#---------------------------------------------
set +x
echo " "
echo "Time at end of `basename $0` is `date`"
#-------------------------END EXTRKR_NEW.SMS.SH-------------------------
